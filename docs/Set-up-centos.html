<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Setting up a multi-user JupyterHub on Centos 7 VM">

<title>Eli’s JupyterHub notes - Centos Set-up</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./set-up-vm.html" rel="next">
<link href="./Set-up-daskhub.html" rel="prev">
<link href="./images/nmfs-opensci-logo2-notext.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Set-up-centos.html">Centos Set-up</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./images/nmfs-opensci-logo2-notext.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./JHub-User-Guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JHub User Guide</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Set-up-daskhub.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JHub Set-up</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Set-up-centos.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Centos Set-up</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./set-up-vm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up VM on mac</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#set-up-vm-on-azure" id="toc-set-up-vm-on-azure" class="nav-link active" data-scroll-target="#set-up-vm-on-azure">Set up VM on Azure</a></li>
  <li><a href="#on-vm-check-set-up" id="toc-on-vm-check-set-up" class="nav-link" data-scroll-target="#on-vm-check-set-up">On VM check set-up</a></li>
  <li><a href="#create-the-conda-environment" id="toc-create-the-conda-environment" class="nav-link" data-scroll-target="#create-the-conda-environment">Create the conda environment</a></li>
  <li><a href="#create-a-user-on-the-vm" id="toc-create-a-user-on-the-vm" class="nav-link" data-scroll-target="#create-a-user-on-the-vm">Create a user on the VM</a></li>
  <li><a href="#open-the-8000-port" id="toc-open-the-8000-port" class="nav-link" data-scroll-target="#open-the-8000-port">Open the 8000 port</a></li>
  <li><a href="#log-in" id="toc-log-in" class="nav-link" data-scroll-target="#log-in">Log in!</a></li>
  <li><a href="#set-up-a-configuration-file" id="toc-set-up-a-configuration-file" class="nav-link" data-scroll-target="#set-up-a-configuration-file">Set up a configuration file</a></li>
  <li><a href="#make-a-new-server-service" id="toc-make-a-new-server-service" class="nav-link" data-scroll-target="#make-a-new-server-service">Make a new server service</a></li>
  <li><a href="#enable-our-new-service" id="toc-enable-our-new-service" class="nav-link" data-scroll-target="#enable-our-new-service">Enable our new service</a></li>
  <li><a href="#create-the-base-user-environment" id="toc-create-the-base-user-environment" class="nav-link" data-scroll-target="#create-the-base-user-environment">Create the base user environment</a></li>
  <li><a href="#multiple-images" id="toc-multiple-images" class="nav-link" data-scroll-target="#multiple-images">Multiple images</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/nmfs-opensci/nmfs-jhub/edit/main/Set-up-centos.Rmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/nmfs-opensci/nmfs-jhub/issues/new" class="toc-action">Report an issue</a></p><p><a href="https://github.com/nmfs-opensci/nmfs-jhub/blob/main/Set-up-centos.Rmd" class="toc-action">View source</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Centos Set-up</h1>
</div>

<div>
  <div class="description">
    <p>Setting up a multi-user JupyterHub on Centos 7 VM</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This is my notes for setting this up on a Centos 7 (Linux distribution) server.</p>
<p><strong>All the commands are run in a shell (bash)</strong></p>
<p>References:</p>
<ul>
<li><a href="https://jupyterhub.readthedocs.io/en/1.2.0/installation-guide-hard.html" class="uri">https://jupyterhub.readthedocs.io/en/1.2.0/installation-guide-hard.html</a> This is an old version (1.2.0) while the newest verson of JupyterHub is 4+. However the 4+ docs do not cover a simple bare metal (own server installation).</li>
<li><a href="https://jupyterhub-dockerspawner.readthedocs.io/en/latest/install.html" class="uri">https://jupyterhub-dockerspawner.readthedocs.io/en/latest/install.html</a></li>
</ul>
<section id="set-up-vm-on-azure" class="level2">
<h2 class="anchored" data-anchor-id="set-up-vm-on-azure">Set up VM on Azure</h2>
<ul>
<li>Created a Centos 8.3 server on Azure: https://portal.azure.com/#create/cloud-infrastructure-services.centos-8-3centos-8-3</li>
<li>I didn’t do anything special for set-up. Choose SSH with key.</li>
<li>Once it is created, I went to the dashboard and selected my VM. The dashboard has a “Connect” button to get to the shell and it shows the public IP address.</li>
<li>I had to create a special security rule to allow me to ssh into the public IP address to connect. Normally I use the cloud shell to connect, but Azure would not let me connect via the cloud shell for a server since it wanted upgraded security and I cannot do that with my work subscription.</li>
<li>Then I saved the key somewhere on my computer and</li>
</ul>
<pre><code>chmod 400 ~/&lt;key location&gt;
ssh -i ~/&lt;key location&gt; &lt;vm-username&gt;@&lt;public key&gt;</code></pre>
</section>
<section id="on-vm-check-set-up" class="level2">
<h2 class="anchored" data-anchor-id="on-vm-check-set-up">On VM check set-up</h2>
<p>I ssh-ed into the VM with</p>
<pre><code>ssh -i &lt;path to key downloaded from Azure&gt; eeholmes@&lt;public ip address&gt;</code></pre>
<section id="make-sure-you-are-root" class="level3">
<h3 class="anchored" data-anchor-id="make-sure-you-are-root">Make sure you are root</h3>
<p>Getting the JupyterHub set up needs to be done as root. First make sure you have an admin password. When I set up my Azure VM, I did not set a password. So first</p>
<pre><code>sudo passwd &lt;your username&gt;</code></pre>
<p>and set a password. Then switch to root if you are not signed in as root</p>
<pre><code>sudo -i</code></pre>
</section>
<section id="check-for-python" class="level3">
<h3 class="anchored" data-anchor-id="check-for-python">Check for Python</h3>
<p>You will need Python 3.6+ installed. Open a terminal window and run <code>python3 --version</code> or <code>python --version</code> to see if Python is installed and what the version is.</p>
<p>Check your operating system (OS) with</p>
<pre><code>cat /etc/os-release</code></pre>
</section>
<section id="check-for-conda" class="level3">
<h3 class="anchored" data-anchor-id="check-for-conda">Check for conda</h3>
<p>You will need conda (or miniconda) for these instructions. conda (and miniconda) take care of checking that all our packages will be inter-operable. It is best to install JupyterHub into a clean environment. That way you minimize chances of conflicts and your environment will solve (figure out any conflicts) much much faster.</p>
<p>Check for conda with</p>
<pre><code>conda list</code></pre>
<p>If it doesn’t show a list of environments, then you need to install miniconda. <a href="https://docs.conda.io/projects/miniconda/en/latest/">Installation instructions</a>. Read about miniconda for scientists from Software Carpentries <a href="https://carpentries-incubator.github.io/introduction-to-conda-for-data-scientists/setup/">here</a>.</p>
<p>This is what I used to install miniconda from <a href="https://docs.conda.io/projects/miniconda/en/latest/index.html#quick-command-line-install">these instructions</a>. Note install miniconda in some place like <code>/opt/miniconda3</code> where all users will have access to `<code>/opt/miniconda3/bin</code>. We don’t want to install in <code>/root/</code> for example or the admin users home directory.</p>
<pre><code>mkdir -p /opt/miniconda3
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /opt/miniconda3/miniconda.sh
bash /opt/miniconda3/miniconda.sh -b -u -p /opt/miniconda3
rm -rf /opt/miniconda3/miniconda.sh</code></pre>
<p>Then initialize to set up the path. Note I am using bash. You’ll need to change if you are using zsh.</p>
<pre><code>/opt/miniconda3/bin/conda init bash
source ~/.bashrc</code></pre>
<p><em>note will need to do something else to add the conda binary to all the users’ paths</em></p>
</section>
</section>
<section id="create-the-conda-environment" class="level2">
<h2 class="anchored" data-anchor-id="create-the-conda-environment">Create the conda environment</h2>
<p>Create the conda environment for the jupyterhub installation. Installation will be in a directory with all the files for packages. Then activate it (enter it), and get the location of the environment (folder).</p>
<p><em>All the commands below are in the terminal window on your VM/server.</em></p>
<p>Create the environment named <code>jupyterhub</code> with python and jupyterhub (module). After creating, activate (enter) that environment. Then install jupyterlab, notebook and dockerspawner into the environment. Note the <code>jupyterhub</code> after <code>-n</code> is the name of the environment.</p>
<pre><code>conda create -n jupyterhub python</code></pre>
<p>Then activate (enter) that environment</p>
<pre><code>conda activate jupyterhub</code></pre>
<p>Then install jupyterhub here</p>
<pre><code>conda install -c conda-forge jupyterhub</code></pre>
<p>and then jupyterlab</p>
<pre><code>conda install -c conda-forge jupyterlab notebook</code></pre>
<section id="set-a-variable-for-env-path" class="level3">
<h3 class="anchored" data-anchor-id="set-a-variable-for-env-path">Set a variable for env path</h3>
<p>The environment has a folder with all the packages and binaries that we install. We are going to need to know the location of that folder. Get the location with</p>
<pre><code>conda env list</code></pre>
<p>On the VM I set up, the folder location is</p>
<pre><code>/opt/miniconda3/envs/jupyterhub</code></pre>
<p>Yours could be something entirely different. On another server with anaconda (a not-free conda package resolver), the folder was</p>
<pre><code>/SHARE/anaconda3/envs/jupterhub/</code></pre>
<p>We are going to be saving the configuration files for our JupyterHub in this folder. Let’s save the path to a variable so we don’t have to keep entering the whole path.</p>
<pre><code>JHUBENV=/opt/miniconda3/envs/jupyterhub</code></pre>
<p>Make sure users can read and execute this folder. They need to in order to be able to spawn instances for the hub.</p>
<pre><code>chmod 755 $JHUBENV</code></pre>
<p>You should now be able to start the hub, but you will not be able to access it yet because you need to open the 8000 port. Type</p>
<pre><code>$JHUBENV/bin/jupyterhub</code></pre>
<p>and check that it starts. Then use Cntl-C to stop the hub.</p>
</section>
</section>
<section id="create-a-user-on-the-vm" class="level2">
<h2 class="anchored" data-anchor-id="create-a-user-on-the-vm">Create a user on the VM</h2>
<p>By default, any user on the server will be able to login. Let’s create a test user so that we are not logging into our hub with the root user password. We will be using “http” until we secure it so passwords are potentially exposed.</p>
<pre><code>useradd jhub</code></pre>
<p>and give it a password when it asks.</p>
</section>
<section id="open-the-8000-port" class="level2">
<h2 class="anchored" data-anchor-id="open-the-8000-port">Open the 8000 port</h2>
<p>FirewallD was not running on my Azure Centos server, so I started it up to manage the ports.</p>
<pre><code>sudo systemctl enable firewalld
sudo systemctl start firewalld</code></pre>
<p>Find out the Public IP address for the server you are on; it’s listed on the Azure overview and networking page for the VM in the Azure portal. Then open the 8000 port.</p>
<p>First find out what ports are open through the firewall</p>
<pre><code>sudo firewall-cmd --list-ports</code></pre>
<p>Add the 8000 port, reload and recheck that it appears.</p>
<pre><code>sudo firewall-cmd  --permanent --add-port 8000/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-ports</code></pre>
<p>Because I am on an Azure VM, I also have to set up a networking rule to allow the 8000 port. By default, all public access to the server is blocked. Go to the Azure dashboard, select your VM, then select Networking under Settings, and then click Add Inbound Port rule. I am pretty sure you need to select “http” instead of “https”.</p>
<p>Once the port is open, you should be able to reach your JupyterHub at <code>http://XXX.XX.XX.XX:8000</code> (replace the XX’s with the Public IP address).</p>
<p><em>Background</em></p>
<p>The JupyterhHub is running by default on <code>http://localhost:8000</code>. This means that if you start the hub on a machine that you are logged into, you should be able to open a browser on that machine, enter <code>http://localhost:8000</code> and the hub login page will appear. There are a few reasons that might not work</p>
<ul>
<li>You are ssh-ing into a server and don’t have a browser to open. The browser on the computer that you are ssh-ing from is the “localhost” in this case and you need the “localhost” to be the server.</li>
<li>You are logged directly into your server, but it doesn’t have a browser installed.</li>
</ul>
<p>However <code>http://localhost:8000</code> is actually not very useful. We are trying to create a hub that others can log into from their browsers.</p>
<p>So you need to determine the Public IP address for the server you are on. This is the IP address that you could enter into a browser. If you enter <code>http://XXX.XX.XX.XX</code> (replace with actual IP), then you should see a page of some sort. This indicates that the server is working. If you are on an internal network, then you will only be able to load the address if you are also on that network. But for security reason, ports will not be open by default. You need to open the 8000 port so that <code>http://XXX.XX.XX.XX:8000</code> will be found.</p>
</section>
<section id="log-in" class="level2">
<h2 class="anchored" data-anchor-id="log-in">Log in!</h2>
<p>At this point, you should be able to login with the <code>jhub</code> test account.</p>
</section>
<section id="set-up-a-configuration-file" class="level2">
<h2 class="anchored" data-anchor-id="set-up-a-configuration-file">Set up a configuration file</h2>
<p>So far, we have started the hub with the default configuration. We are going to need to customize it. For that we need a configuration file. We will create this in the folder where the environment files are.</p>
<pre><code>sudo mkdir -p $JHUBENV/etc/jupyterhub/
cd $JHUBENV/etc/jupyterhub/</code></pre>
<p>Next create the default configuration file <code>jupyterhub_config.py</code>.</p>
<pre><code>sudo $JHUBENV/bin/jupyterhub --generate-config</code></pre>
<p>Because we <code>cd</code>-d into the <code>$JHUBENV/etc/jupyterhub/</code> directory, the file is created there. This default file is very long. Open up with</p>
<pre><code>nano jupyterhub_config.py</code></pre>
<p>Use F6 to find lines. Uncomment these two lines and save (Cntl-O, Enter, Cntl-X).</p>
<pre><code>c.Spawner.default_url = '/lab'
c.Spawner.http_timeout = 3600</code></pre>
</section>
<section id="make-a-new-server-service" class="level2">
<h2 class="anchored" data-anchor-id="make-a-new-server-service">Make a new server service</h2>
<section id="create-the-new-unit-file" class="level3">
<h3 class="anchored" data-anchor-id="create-the-new-unit-file">Create the new unit file</h3>
<p>At this point, after opening the port, you should be able to get to your JupyterHub by starting it with <code>jupyterhub --ip XXX.XX.XX.XX --port=8000</code> and then browsing to <code>http://XXX.XX.XX.XX:8000</code>. But you hub is going to be stopped whenever the server is rebooted. So next we need to set up a service for your service so that our hub starts automatically.</p>
<p>Create a new directory for the service unit file,</p>
<pre><code>sudo mkdir -p $JHUBENV/etc/systemd
cd $JHUBENV/etc/systemd</code></pre>
<p>Create the file and name <code>jupyterhub.service</code>. For example, using nano editor, we do</p>
<pre><code>nano jupyterhub.service</code></pre>
<p>And into that file we put the following. Replace <code>/opt/miniconda3/envs/jupyterhub</code> with the actual path to the jupyterhub environment folder.</p>
<pre><code>[Unit]
Description=JupyterHub
After=syslog.target network.target

[Service]
User=root
Environment="PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/opt/miniconda3/envs/jupyterhub/bin"
ExecStart=/opt/miniconda3/envs/jupyterhub/bin/jupyterhub -f /opt/miniconda3/envs/jupyterhub/etc/jupyterhub/jupyterhub_config.py

[Install]
WantedBy=multi-user.target</code></pre>
<p>Next we make systemd aware of the new service.</p>
<p>Create a symlink file in the folder where all the server services are kept. And tell <code>systemd</code> to reload its configuration files</p>
<pre><code>sudo ln -s $JHUBENV/etc/systemd/jupyterhub.service /etc/systemd/system/jupyterhub.service
sudo systemctl daemon-reload</code></pre>
</section>
<section id="make-sure-selinux-doesnt-block-our-service" class="level3">
<h3 class="anchored" data-anchor-id="make-sure-selinux-doesnt-block-our-service">Make sure SELinux doesn’t block our service</h3>
<p>SELinux (security for the server) checks that files that are used have the correct label. All our files have generic file labels. If you do,</p>
<pre><code>ls -Z $JHUBENV/etc/systemd/</code></pre>
<p>You will see that the file label is <code>unconfined_u:object_r:usr_t:s0</code>. We need it to be</p>
<pre><code>systemd_unit_file_t</code></pre>
<p>We change the file label with</p>
<pre><code>sudo chcon system_u:object_r:systemd_unit_file_t:s0 $JHUBENV/etc/systemd/jupyterhub.service</code></pre>
<p>SELinux will also object to the file label on all the binaries that we use to start up the JupyterHub (like <code>jupyterhub</code>) so we need to fix those file labels.</p>
<p>This will add <code>bin_t</code> label to all the binaries and check that it worked.</p>
<pre><code>sudo find $JHUBENV/bin -type f -exec chcon system_u:object_r:bin_t:s0 {} \;
ls -Z $JHUBENV/bin</code></pre>
<p>It got all the binaries but not the simlinks. Nonetheless it seemed to run ok.</p>
</section>
</section>
<section id="enable-our-new-service" class="level2">
<h2 class="anchored" data-anchor-id="enable-our-new-service">Enable our new service</h2>
<pre><code>sudo systemctl enable jupyterhub.service</code></pre>
<p>The service will start on reboot, but we can start it straight away using <code>start</code>:</p>
<pre><code>sudo systemctl start jupyterhub.service</code></pre>
<p>Check that it is running.</p>
<pre><code>sudo systemctl status jupyterhub.service</code></pre>
<p>If it fails, try</p>
<pre><code>audit2why &lt; /var/log/audit/audit.log</code></pre>
<p>to debug. It is likely to be an issue with SELinux blocking the service from starting.</p>
<p>Now our hub should be available on <code>http:\\XXX.XX.XX.XX:8000</code>. You can double check that it is listen on this port by running</p>
<pre><code>netstat -tuln</code></pre>
<p>At this point, you will need to address security if your hub is open to the web, as opposed to being on an internal network and only accessible to that network. Learn about that <a href="https://jupyterhub.readthedocs.io/en/1.2.0/installation-guide-hard.html">here</a>.</p>
</section>
<section id="create-the-base-user-environment" class="level2">
<h2 class="anchored" data-anchor-id="create-the-base-user-environment">Create the base user environment</h2>
<p>When you log in the jupyter notebooks will be trying to use the Python environment that was created to install JupyterHub, this is not what we want. We will use a docker image to “spawn” the user environment. Read <a href="https://jupyterhub.readthedocs.io/en/1.2.0/installation-guide-hard.html#part-2-conda-environments">here</a> for other approaches.</p>
<p>We are going to use <a href="https://jupyterhub-dockerspawner.readthedocs.io/">dockerspawner</a> so that we can use a docker image for our user environments. The user will work in these containerized environments and they won’t have access to any other files in the server. In order to share their work with others, the normal workflow would be to work in Git repos and share those repos to a GitHub (or GitLab server). Each user will have a home directory on the server for their files, but they won’t have access to other hub user directories nor will they have access to any other directories on the server.</p>
<section id="install-docker" class="level3">
<h3 class="anchored" data-anchor-id="install-docker">Install docker</h3>
<p>I am using Centos in this example</p>
<pre><code>sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</code></pre>
<p>Then we need to start docker</p>
<pre><code>sudo systemctl start docker</code></pre>
<p>Not sure this is needed.</p>
<pre><code>sudo firewall-cmd --zone=docker --add-port=8081/tcp
sudo firewall-cmd --reload
sudo systemctl restart docker</code></pre>
</section>
<section id="install-dockerspawner" class="level3">
<h3 class="anchored" data-anchor-id="install-dockerspawner">Install dockerspawner</h3>
<p>I am going to be creating the user environment from a docker image, so I also want dockerspawner. Note dockerspawner installed docker-py but it was really old and threw errors so I installed separately to get the latest version. Note make sure you are in the jupyterhub conda env. You can run <code>conda env list</code> and use <code>conda activate jupyterhub</code> if you are not in it.</p>
<pre><code>conda install -c conda-forge dockerspawner
conda install -c conda-forge docker-py</code></pre>
</section>
<section id="check-that-the-versions-of-jupyterhub-match" class="level3">
<h3 class="anchored" data-anchor-id="check-that-the-versions-of-jupyterhub-match">Check that the versions of jupyterhub match</h3>
<p><em>Not sure this is necessary</em></p>
<p>The image that we use must have the jupyterhub module installed and the version of jupyterhub on your server must match that in the image.</p>
<p>Check the version on your server:</p>
<pre><code>$JHUBENV/bin/jupyterhub -V</code></pre>
<p>For demo purposes, we will use the <code>jupyter/scipy-notebook</code> images on DockerHub. We want to find an image with the same version of jupyterhub as we have on our server.</p>
</section>
<section id="edit-the-config-file" class="level3">
<h3 class="anchored" data-anchor-id="edit-the-config-file">Edit the config file</h3>
<p>Edit the <code>jupyterhub_config.py</code> file in <code>$JHUB-ENV/etc/jupyterhub/</code> to add that we want to use DockerSpawner and specify the image. Add these lines to <code>jupyterhub_config.py</code>. The hub bind url needs to be 0.0.0.0 because we are using a docker container for the individual user environments.</p>
<ul>
<li>https://discourse.jupyter.org/t/whats-the-main-difference-between-hub-connect-url-vs-hub-bind-url/3596/2</li>
</ul>
<pre><code>c = get_config()  #noqa
c.JupyterHub.port = 8000
c.JupyterHub.hub_bind_url = "http://0.0.0.0:8081"
c.JupyterHub.spawner_class = 'dockerspawner.DockerSpawner'
c.DockerSpawner.remove = True
c.Spawner.http_timeout = 3600
c.DockerSpawner.image_whitelist = {
    'datascience-r': 'jupyter/datascience-notebook:r-4.3.1',
    'scipy-notebook': 'jupyter/scipy-notebook:7e1a19a8427f',
}</code></pre>
<p>Did not do the below. Did add 8081 as a port but not sure I needed to.</p>
<ul>
<li>https://serverfault.com/questions/987686/no-network-connectivity-to-from-docker-ce-container-on-centos-8</li>
</ul>
<pre><code>sudo nmcli connection modify docker0 connection.zone public
sudo firewall-cmd --zone=public --add-masquerade --permanent
sudo firewall-cmd --reload</code></pre>
</section>
</section>
<section id="multiple-images" class="level2">
<h2 class="anchored" data-anchor-id="multiple-images">Multiple images</h2>
<p>https://github.com/jupyterhub/dockerspawner/issues/400</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Set-up-daskhub.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">JHub Set-up</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./set-up-vm.html" class="pagination-link">
        <span class="nav-page-text">Set-up VM on mac</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><img src="./images/nmfs-opensci-logo2-notext.png" alt="NMFS OpenSci logo" style="width:150px"><br>NMFS OpenSci (2023)</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>