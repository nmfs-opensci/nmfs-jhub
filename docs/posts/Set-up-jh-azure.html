<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Second time setting up a multi-user JupyterHub with Dask enabled">

<title>Eli’s JupyterHub notes - JHub Set-up on Azure</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../posts/set-up-jh-gcp.html" rel="next">
<link href="../posts/Set-up-daskhub.html" rel="prev">
<link href="../images/nmfs-opensci-logo2-notext.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../posts/Set-up-jh-azure.html">Set-up DaskHub on Azure 2</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../images/nmfs-opensci-logo2-notext.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.Rmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/JHub-User-Guide.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JHub User Guide</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/Set-up-daskhub.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up DaskHub on Azure</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/Set-up-jh-azure.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Set-up DaskHub on Azure 2</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/set-up-jh-gcp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up JHub on GCP</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/set-up-jh-aws.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up JHub on AWS</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/Set-up-centos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up JHub on Centos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/Set-up-centos-security.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up https on Centos</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/set-up-authentication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Set-up authentication</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../posts/tips.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tips</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#requirements" id="toc-requirements" class="nav-link active" data-scroll-target="#requirements">Requirements</a></li>
  <li><a href="#open-the-azure-cloud-shell" id="toc-open-the-azure-cloud-shell" class="nav-link" data-scroll-target="#open-the-azure-cloud-shell">Open the Azure Cloud Shell</a></li>
  <li><a href="#create-your-kubernetes-cluster" id="toc-create-your-kubernetes-cluster" class="nav-link" data-scroll-target="#create-your-kubernetes-cluster">Create your Kubernetes cluster</a></li>
  <li><a href="#create-user-node-pools" id="toc-create-user-node-pools" class="nav-link" data-scroll-target="#create-user-node-pools">Create user node pools</a></li>
  <li><a href="#check-out-what-you-created" id="toc-check-out-what-you-created" class="nav-link" data-scroll-target="#check-out-what-you-created">Check out what you created</a></li>
  <li><a href="#install-daskhub-on-your-cluster" id="toc-install-daskhub-on-your-cluster" class="nav-link" data-scroll-target="#install-daskhub-on-your-cluster">Install DaskHub on your cluster</a></li>
  <li><a href="#set-up-https" id="toc-set-up-https" class="nav-link" data-scroll-target="#set-up-https">Set up https</a></li>
  <li><a href="#step-3-set-up-github-authentication" id="toc-step-3-set-up-github-authentication" class="nav-link" data-scroll-target="#step-3-set-up-github-authentication">Step 3 Set up GitHub authentication</a></li>
  <li><a href="#set-up-the-container-image" id="toc-set-up-the-container-image" class="nav-link" data-scroll-target="#set-up-the-container-image">Set up the container image</a></li>
  <li><a href="#test-a-full-config-file" id="toc-test-a-full-config-file" class="nav-link" data-scroll-target="#test-a-full-config-file">Test a full config file</a></li>
  <li><a href="#create-a-2t-shared-drive" id="toc-create-a-2t-shared-drive" class="nav-link" data-scroll-target="#create-a-2t-shared-drive">Create a 2T shared drive</a></li>
  <li><a href="#final-config.yaml" id="toc-final-config.yaml" class="nav-link" data-scroll-target="#final-config.yaml">Final config.yaml</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/nmfs-opensci/nmfs-jhub/edit/main/posts/Set-up-jh-azure.Rmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/nmfs-opensci/nmfs-jhub/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/nmfs-opensci/nmfs-jhub/blob/main/posts/Set-up-jh-azure.Rmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">JHub Set-up on Azure</h1>
</div>

<div>
  <div class="description">
    <p>Second time setting up a multi-user JupyterHub with Dask enabled</p>
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements</h2>
<ul>
<li>Documentation: <a href="https://z2jh.jupyter.org">https://z2jh.jupyter.org</a></li>
</ul>
<p>See full <code>config.yaml</code> files in the <code>config-template</code> directory in the <a href="https://github.com/nmfs-opensci/nmfs-jhub">nmfs-opensci/nmfs-jhub</a> GitHub repo. Name of config file is <code>fish-config.yaml</code>.</p>
<ul>
<li>Domain Name: You will need one. I use Godaddy. They are cheap.</li>
</ul>
<section id="steps" class="level3">
<h3 class="anchored" data-anchor-id="steps">Steps</h3>
<ul>
<li>Open the Azure Cloud Shell</li>
<li>Create a Kubernetes cluster</li>
<li>Create the node pools (what types of VMs)</li>
<li>Install JupyterHub with Dask</li>
<li>Edit the config file</li>
<li>Set up https</li>
<li>Set up authentication</li>
<li>Once it is working, you can create user shared drive</li>
</ul>
</section>
</section>
<section id="open-the-azure-cloud-shell" class="level2">
<h2 class="anchored" data-anchor-id="open-the-azure-cloud-shell">Open the Azure Cloud Shell</h2>
<p>I am using a simpler version of the instructions here: <a href="https://z2jh.jupyter.org/en/stable/kubernetes/microsoft/step-zero-azure.html">Z2JH Set up Kubernetes on Azure</a>. To see how to do these steps using the Azure Dashboard go to the <a href="posts/Set-up-daskhub.html">DaskHub Set-up on Azure</a>. If this is your first time setting up a hub on Azure, it would be good to skim that post to get an overview of the process.</p>
<ol type="1">
<li><p>Log into <code>https:\\portal.azure.com</code></p></li>
<li><p>Look for the Cloud Shell icon in the top nav bar. Box with a right pointing arrow in it. Click on that and use bash shell not the Power Shell.</p></li>
<li><p>Make sure to set up a storage account. You can just have Azure set one up for you. If you forget and later get warnings that your shell is ephemeral, then go into settings in the cloud shell and reset the user settings.</p></li>
</ol>
</section>
<section id="create-your-kubernetes-cluster" class="level2">
<h2 class="anchored" data-anchor-id="create-your-kubernetes-cluster">Create your Kubernetes cluster</h2>
<p>We have to create a resource group.</p>
<pre><code># Create names
RES_GP="SAFSJHub"
CLUSTER_NAME="jhub"

# Create a resource group
az group create \
   --name=$RES_GP \
   --location=westus2 \
   --output table</code></pre>
<p>Then we create a cluster with <a href="https://learn.microsoft.com/en-us/cli/azure/aks?view=azure-cli-latest#az-aks-create">az aks create</a>. I am going to accept most of the defaults. This will create our cluster and create the first node pool which just runs the hub (not the user VMs). This node (VM) must always be running and there is only ever one (so no autoscaling).</p>
<pre><code># Create the cluster
az aks create \
   --name $CLUSTER_NAME \
   --resource-group $RES_GP \
   --node-vm-size Standard_D2s_v3 \
   --generate-ssh-keys \
   --node-count 1 \
   --nodepool-name core \
   --nodepool-labels hub.jupyter.org/node-purpose=core \
   --zones 2 \
   --location westus2</code></pre>
<ul>
<li><code>--name</code> name of our cluster. I made a variable called <code>$HUB_NAME</code></li>
<li><code>--node-vm-size Standard_D2s_v3</code> This is a 2 CPU and 4 Gb RAM VM to run the hub itself (so not the user VMs). Costs about $80 a month.</li>
<li><code>--generate-ssh-keys</code> Just use the default generator.</li>
<li><code>--node-count 1</code> There is only ever one core node which the hub server runs alone on.</li>
<li><code>--nodepool-name core</code> Required. This is the name of the node pool for the hub.</li>
<li><code>--nodepool-labels hub.jupyter.org/node-purpose=core</code> so that when you do queries re the nodes and pods, you can make sense of the output.</li>
<li><code>--zones 2</code> Probably not needed here. Only needed for user pods.</li>
<li><code>--location westus2</code> Required. Pick something close. use <code>az account list-locations --output table</code> to see a list of the options.</li>
<li><code>--output table</code> So that output is pretty.</li>
</ul>
</section>
<section id="create-user-node-pools" class="level2">
<h2 class="anchored" data-anchor-id="create-user-node-pools">Create user node pools</h2>
<p>This will define the types of VMs that will spin up for our users. In the JHub, I am creating, the users can request a minimum amount of RAM from 2-128Gb. For normal uses, the users will select 2 or 4 Gb and 16 to 8 users will be sharing each VM. If a VM runs out of RAM, then another will be spun up. I want to create a separate node pool for 128Gb requests because that is an expensive VM and I only want that if a user requests it (it will go away after the user shuts down their server).</p>
<p>Before you get started, take a look at <a href="https://portal.azure.com/#view/Microsoft_Azure_Capacity/QuotaMenuBlade/~/myQuotas">your quota</a>. Your CPUs*<code>max-count</code> for all node pools should not exceed that.</p>
<p>What sort of machines should I put in my node pool?</p>
<ul>
<li>Lots of memory intensive work? Lower CPU and higher RAM (memory optimized).</li>
<li>Lots of parallel processing or batch processing? Lots of CPU and lower RAM (compute optimized).</li>
</ul>
<p>Create the 32Gb RAM w 4 CPU node pool. This is a standard base user node for JupyterHubs.</p>
<pre><code>az aks nodepool add \
    --cluster-name $CLUSTER_NAME \
    --resource-group $RES_GP \
    --name usermedium \
    --enable-cluster-autoscaler \
    --min-count 0 \
    --max-count 4 \
    --node-vm-size Standard_E4as_v5 \
    --labels hub.jupyter.org/node-purpose=usermedium \
    --zones 2</code></pre>
<ul>
<li><code>--name usersmall</code> give this node pool a unique name. We will need this in our JHub config file.</li>
<li><code>--enable-cluster-autoscaler</code> Required. We want more VMs to be spun up if more users sign into the hub.</li>
<li><code>--min-count 0</code> We want the minimum to be 0 because if there are no users, then we don’t need a user VM (node) to be running and costing money.</li>
<li><code>--max-count 4</code> This should accommodate roughly 32-64 users if most users are requesting 2-4 Gb of RAM. This is 4*8 = 32 CPU if all nodes are in use.</li>
<li><code>--node-vm-size Standard_E4as_v5</code> This is a general use VM with 32 Gb RAM and 4 CPU. Similar to AWS <code>r5.xlarge</code>.</li>
<li><code>--labels hub.jupyter.org/node-purpose=usersmall</code> So that we can decipher our node and pod output.</li>
<li><code>--zones 2</code> Very important. We have to pin our user storage to a specific region and zone. We don’t want our nodes (VMs) to ever spin up in a zone different than our user (cloud) storage.</li>
</ul>
<p>Create the 128Gb RAM/16 CPU node pool. Everything is the same except <code>Standard_E16as_v5</code> and the node pool name. This is similar to AWS <code>r5.4xlarge</code>.</p>
<pre><code>az aks nodepool add \
    --cluster-name $CLUSTER_NAME \
    --name userxlarge \
    --resource-group $RES_GP \
    --enable-cluster-autoscaler \
    --min-count 0 \
    --max-count 3 \
    --node-vm-size Standard_E16as_v5 \
    --labels hub.jupyter.org/node-purpose=userlarge \
    --zones 2</code></pre>
<ul>
<li><code>--node-count 2</code> The default is 3 and it threw an error if I didn’t pass this in.</li>
</ul>
</section>
<section id="check-out-what-you-created" class="level2">
<h2 class="anchored" data-anchor-id="check-out-what-you-created">Check out what you created</h2>
<p>Click on the Kubernetes Services button and you should see something like this</p>
<p><img src="../images/img2.png" class="img-fluid"></p>
<p>Click Kubernetes Cluster and then on the <code>jhub</code> cluster. Poke around on the tabs and look at the node pools.</p>
</section>
<section id="install-daskhub-on-your-cluster" class="level2">
<h2 class="anchored" data-anchor-id="install-daskhub-on-your-cluster">Install DaskHub on your cluster</h2>
<p>These next steps are done in the shell after connecting to your cluster. First you need to get to the shell <strong>for your cluster</strong>. Make sure you don’t have the ephemeral warning when you launch your cloud shell.</p>
<section id="connect-to-your-cluster" class="level3">
<h3 class="anchored" data-anchor-id="connect-to-your-cluster">Connect to your cluster</h3>
<p>Once you have created your Kubernetes cluster, you want to go to its dashboard (by clicking on the name you gave it). You’ll see something like this (in this image the cluster is named <code>daskhub</code>).</p>
<p><img src="../images/img4.png" class="img-fluid"></p>
<p>Click on the Connect icon to the right of “+ Create”.</p>
<p>You then see this</p>
<p><img src="../images/img5.png" class="img-fluid"></p>
<p>Click on the link that says “Open Cloud Shell”.</p>
<p><img src="../images/img6.png" class="img-fluid"></p>
<p>You will get to a terminal and it should automatically run those <code>az</code> commands.</p>
</section>
<section id="create-config.yaml" class="level3">
<h3 class="anchored" data-anchor-id="create-config.yaml">Create <code>config.yaml</code></h3>
<p>This will be the configuration file for your JupyterHub. For now, it can be just comments. Note the name is unimportant but should end in <code>.yaml</code>.</p>
<pre><code>nano config.yaml</code></pre>
<p>This will open the nano editor. Edit your file. You can do <code># just blank for now</code>. Then <code>Cntl-O</code> to save and <code>Cntl-X</code> to exit.</p>
</section>
<section id="install-daskhub-via-helm-chart" class="level3">
<h3 class="anchored" data-anchor-id="install-daskhub-via-helm-chart">Install daskhub via helm chart</h3>
<p>Instructions: <a href="https://artifacthub.io/packages/helm/dask/daskhub" class="uri">https://artifacthub.io/packages/helm/dask/daskhub</a> .</p>
<p>Check that helm is installed. It should be.</p>
<pre><code>helm version</code></pre>
<p>Tell helm about the dask helm repository</p>
<pre><code>helm repo add dask https://helm.dask.org
helm repo update</code></pre>
<p>Now install. The first <code>dhub</code> is your release name and the second is the namespace name.</p>
<pre><code>helm upgrade --wait --install --render-subchart-notes \
    dhub dask/daskhub \
    --namespace=dhub --create-namespace \
    --values=config.yaml</code></pre>
<p>You will see this on successful installation (it’s long. much has been cut). <img src="../images/img7.png" class="img-fluid"></p>
</section>
<section id="set-up-your-external-ip-address" class="level3">
<h3 class="anchored" data-anchor-id="set-up-your-external-ip-address">Set-up your external IP address</h3>
<p>Set the namespace context for the Kubernetes cluster and the the external IP address.</p>
<pre><code>kubectl config set-context $(kubectl config current-context) --namespace dhub
kubectl --namespace=dhub get service proxy-public</code></pre>
<p>These commands will show the the IP address. Save the public IP address. You will need it in step 2. Look for the IP address under <code>EXTERNAL-IP</code>.</p>
</section>
</section>
<section id="set-up-https" class="level2">
<h2 class="anchored" data-anchor-id="set-up-https">Set up https</h2>
<p>You can log out of your cluster. The next steps are done elsewhere.</p>
<section id="create-a-domain-name" class="level3">
<h3 class="anchored" data-anchor-id="create-a-domain-name">Create a domain name</h3>
<p>You will need a domain name for <code>https</code> which you want for security (and JupyterHub won’t stop complaining if you don’t). Find a domain name provider and set one up. It is not expensive. I used GoDaddy. If you already have one, you don’t need another. You create a subdomain under that.</p>
</section>
<section id="create-a-dns-entry" class="level3">
<h3 class="anchored" data-anchor-id="create-a-dns-entry">Create a DNS entry</h3>
<p>Let’s pretend you set up <code>bluemountain123.live</code> as the domain. Go to the DNS settings for your domain. Add a type A record. This will do 2 things. First this will create the subdomain that you will use to access your JupyterHub. So let’s say you create, <code>dhub</code> as the type A DNS entry. Then <code>dhub.bluemountain123.live</code> will be the url. You can have as many subdomains as you need.</p>
<p><img src="../images/img8.png" class="img-fluid"></p>
</section>
<section id="test-if-the-url-is-working" class="level3">
<h3 class="anchored" data-anchor-id="test-if-the-url-is-working">Test if the url is working</h3>
<p><code>http:\\dhub.bluemountain123.live</code> would be the url using the example domain above. Test that it is working (shows a JupyterHub login) before moving on. This is what you should see:</p>
<p><img src="../images/img9.png" class="img-fluid"></p>
</section>
<section id="set-up-https-on-your-jupyterhub" class="level3">
<h3 class="anchored" data-anchor-id="set-up-https-on-your-jupyterhub">Set-up https on your JupyterHub</h3>
<p>Log back into your Kubernetes cluster: go to portal.azure.com, click on your Kubernetes cluster name, and then click on “Connect”. Then click on “Open Cloud Shell”. <a href="https://tljh.jupyter.org/en/latest/howto/admin/https.html">Read documentation about https</a></p>
<p>Once you are on the shell, type</p>
<pre><code>nano config.yaml</code></pre>
<p>to edit the config file. Paste this in and save. Note the additional <code>jupyterhub:</code> in the yaml file. This is not in a plain JupyterHub with Kubernetes config file (i.e.&nbsp;in a non-daskhub, the <code>jupyterhub:</code> bit is not there and everything is moved to left by 2 spaces).</p>
<pre><code>jupyterhub:
  proxy:
    https:
      enabled: true
      hosts:
        - dhub.bluemountain123.live
      letsencrypt:
        contactEmail: your@email.com</code></pre>
</section>
<section id="update-the-jupyterhub-installation" class="level3">
<h3 class="anchored" data-anchor-id="update-the-jupyterhub-installation">Update the JupyterHub installation</h3>
<p>Anytime you change <code>config.yaml</code> you need to run this code. Find the latest version <a href="https://artifacthub.io/packages/helm/dask/daskhub">here</a>.</p>
<pre><code>helm upgrade --cleanup-on-fail --render-subchart-notes dhub dask/daskhub --namespace dhub --version=2024.1.1 --values config.yaml</code></pre>
</section>
<section id="test-if-https-is-working" class="level3">
<h3 class="anchored" data-anchor-id="test-if-https-is-working">Test if https is working</h3>
<p><strong>COME BACK IN AN HOUR</strong> It takes awhile for a certificate to be issued. If it still doesn’t work, try editing the config file and re-upgrading.</p>
<p>Try <code>https:\\dhub.bluemountain123.live</code> and you should see the JupyterHub login without that http warning.</p>
</section>
</section>
<section id="step-3-set-up-github-authentication" class="level2">
<h2 class="anchored" data-anchor-id="step-3-set-up-github-authentication">Step 3 Set up GitHub authentication</h2>
<p>Optional, if you want to manage who can login via GitHub Team. I am going to show an example where I use a team on a GitHub organization to manage authentication. There are many other ways to manage users. Google to find that.</p>
<section id="create-a-new-oauth-application-on-github" class="level3">
<h3 class="anchored" data-anchor-id="create-a-new-oauth-application-on-github">Create a new Oauth Application on GitHub</h3>
<p>This is going to be associated with your (personal) GitHub account, but you can use a team on a GitHub org that you are owner of.</p>
<p>Log into GitHub and go to GitHub &gt; Settings &gt; Developer Settings &gt; Oauth Apps &gt; Register New Oauth Application</p>
<p>Look carefully at how I filled in the boxes.</p>
<p><img src="../images/img10.png" class="img-fluid"></p>
<p>Next you will see something like this</p>
<p><img src="../images/img11.png" class="img-fluid"></p>
<p>You need to copy the ID and then click the create secrets button and save the secret. Save those for later.</p>
</section>
<section id="create-a-team-in-your-github-org" class="level3">
<h3 class="anchored" data-anchor-id="create-a-team-in-your-github-org">Create a team in your GitHub org</h3>
<p>You will be added by default and add anyone else who needs access to the hub. Let’s say your org is <code>MyOrg</code> and the team is called <code>DaskHub</code>. So then the allowed organization is MyOrg:DaskHub. You can leave off <code>:DaskHub</code> if you want to allow all members of the organization to log in.</p>
</section>
<section id="edit-the-config.yaml-file" class="level3">
<h3 class="anchored" data-anchor-id="edit-the-config.yaml-file">Edit the <code>config.yaml</code> file</h3>
<pre><code>nano config.yaml</code></pre>
<p>Add to your config file so it is now this. Replace the id, secret and url with your values.</p>
<pre><code>jupyterhub:
  hub:
    config:
      GitHubOAuthenticator:
        client_id: &lt;replace with your OAuth id&gt;
        client_secret: &lt;replace with your OAuth app secret&gt;
        oauth_callback_url: https://dhub.bluemountain123.live/hub/oauth_callback
        allowed_organizations:
          - MyOrg:DaskHub
        scope:
          - read:org
      JupyterHub:
        authenticator_class: github
      KubeSpawner:
        working_dir: /home/jovyan
  proxy:
    https:
      enabled: true
      hosts:
        - dhub.bluemountain123.live
      letsencrypt:
        contactEmail: your@email.com        </code></pre>
</section>
<section id="update-the-hub" class="level3">
<h3 class="anchored" data-anchor-id="update-the-hub">Update the hub</h3>
<pre><code>helm upgrade --cleanup-on-fail --render-subchart-notes dhub dask/daskhub --namespace dhub --version=2024.1.1 --values config.yaml</code></pre>
</section>
<section id="test" class="level3">
<h3 class="anchored" data-anchor-id="test">Test</h3>
<p>You should now see this and can authenticate with GitHub.</p>
<p><img src="../images/img12.png" class="img-fluid"></p>
</section>
</section>
<section id="set-up-the-container-image" class="level2">
<h2 class="anchored" data-anchor-id="set-up-the-container-image">Set up the container image</h2>
<p>Now you need to specify the Docker image that will be used. Edit the <code>config.yaml</code> file and add the user image info. Note the spacing matters (a lot).</p>
<pre><code>  singleuser:
    image:
      name: openscapes/python
      tag: f577786
    cmd: null
  singleuser:
    # Defines the default image
    image:
      name: openscapes/python
      tag: f577786
    profileList:
      - display_name: "Python3"
        description: "NASA Openscapes Python image"
        default: true
      - display_name: "R"
        description: "NASA Openscapes RStudio image"
        kubespawner_override:
          image: openscapes/rocker:a7596b5        </code></pre>
</section>
<section id="test-a-full-config-file" class="level2">
<h2 class="anchored" data-anchor-id="test-a-full-config-file">Test a full config file</h2>
<p>My config.yaml is a bit more customized to allow the user to reserve the amount of RAM that they need. Full config file: <a href="https://github.com/nmfs-opensci/nmfs-jhub/blob/main/config-template/fish-config.yaml" class="uri">https://github.com/nmfs-opensci/nmfs-jhub/blob/main/config-template/fish-config.yaml</a></p>
<p>Cut out the part regarding the shared drive:</p>
<pre><code>      extraVolumes:
        - name: jupyterhub-shared
          persistentVolumeClaim:
            claimName: daskhub-pvc
      extraVolumeMounts:
        - name: jupyterhub-shared
          mountPath: /home/jovyan/shared</code></pre>
<p>And make sure the hub is working nicely before adding a shared drive. The shared drive part tends to break things.</p>
</section>
<section id="create-a-2t-shared-drive" class="level2">
<h2 class="anchored" data-anchor-id="create-a-2t-shared-drive">Create a 2T shared drive</h2>
<p>This will cost about $172 a month. Here are some notes on how to do this: https://www.c2labs.com/post/persistent-storage-on-kubernetes-for-azure</p>
<section id="create-a-storage-account-in-the-portal" class="level3">
<h3 class="anchored" data-anchor-id="create-a-storage-account-in-the-portal">Create a storage account in the portal</h3>
<p>First we must create a storage account (add the resource). The name must be globally unique, so don’t use the one here.</p>
<ul>
<li>Go to the dashboard and look for “storage account”</li>
<li>Create one with a unique name</li>
<li>Use the resource group that the Kubernetes cluster is in. For me it is SAFSJHub</li>
<li>Choose Standard LRS storage</li>
<li>Kind StorageV2</li>
<li><strong>key bit</strong> you need to set the storage to use the VNET associated with the cluster. Look at the cluster. The VNET you want will be something like <code>aks-vnet-123</code>.</li>
<li><strong>key bit</strong> you need to create a file share. Make it 2Tb by changing the quota to 2048. Make sure it uses the same resource group as the cluster.</li>
</ul>
<p>Something like this might work but you need to set the VNET.</p>
<pre><code>az storage account create \
  --name safshubnfs \
  --resource-group SAFSJHub \
  --location westus2 \
  --sku Standard_LRS \
  --kind StorageV2 </code></pre>
</section>
<section id="set-up-the-storage-class-pv-and-pvc" class="level3">
<h3 class="anchored" data-anchor-id="set-up-the-storage-class-pv-and-pvc">Set up the storage class, PV and PVC</h3>
<pre><code>mkdir nfs-shared-setup
cd nfs-shared-setup</code></pre>
<p>In here we create 3 files.</p>
<p>sc.yaml</p>
<pre><code>apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: dask-fileshare
provisioner: file.csi.azure.com
allowVolumeExpansion: true
mountOptions:
  - nconnect=10 # per pod number of connections
parameters:
  resourceGroup: SAFSJHub
  server: safshubnfs.file.core.windows.net
  storageAccount: safshubnfs # storage account created manually
  shareName: daskhub-shared # a file share created manually
  protocol: nfs</code></pre>
<p>pv.yaml</p>
<pre><code>apiVersion: v1
kind: PersistentVolume
metadata:
  annotations:
    pv.kubernetes.io/provisioned-by: file.csi.azure.com
  name: daskhub-pv
spec:
  capacity:
    storage: 2048Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain  # if set as "Delete" file share would be removed in pvc deletion
  storageClassName: dask-fileshare
  csi:
    driver: file.csi.azure.com
    readOnly: false
    volumeHandle: daskhub-shared
    volumeAttributes:
      resourceGroup: SAFSJHub
      storageAccount: daskhubnfs
      shareName: daskhub-shared
      protocol: nfs</code></pre>
<p>pvc.yaml</p>
<pre><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: daskhub-pvc
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: dask-fileshare
  resources:
    requests:
      storage: 2048Gi</code></pre>
<p>Now set everything up. Storage Classes and Persisten Volumes are not scoped to a namespace but Persistent Volume Claims are.</p>
<pre><code># Apply storage class. View with "kubectl get sc"
kubectl apply -f sc.yaml

# Apply the Persistent Volume
kubectl apply -f pv.yaml

# Apply the Persistent Volume Claim
kubectl apply -f pvc.yaml --namespace=dhub</code></pre>
</section>
<section id="add-the-storage-class-to-the-config.yaml" class="level3">
<h3 class="anchored" data-anchor-id="add-the-storage-class-to-the-config.yaml">Add the storage class to the config.yaml</h3>
<p>It will look like this.</p>
<pre><code>  singleuser:
    startTimeout: 3600
    defaultUrl: /lab
    storage:
      capacity: 50Gi
      extraVolumes:
        - name: jupyterhub-shared
          persistentVolumeClaim:
            claimName: daskhub-pvc
      extraVolumeMounts:
        - name: jupyterhub-shared
          mountPath: /home/jovyan/shared</code></pre>
</section>
</section>
<section id="final-config.yaml" class="level2">
<h2 class="anchored" data-anchor-id="final-config.yaml">Final config.yaml</h2>
<p>My config.yaml is a bit more customized to allow the user to reserve the amount of RAM that they need.</p>
<p>Full config file: <a href="https://github.com/nmfs-opensci/nmfs-jhub/blob/main/config-template/fish-config.yaml" class="uri">https://github.com/nmfs-opensci/nmfs-jhub/blob/main/config-template/fish-config.yaml</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../posts/Set-up-daskhub.html" class="pagination-link  aria-label=" set-up="" daskhub="" on="" azure"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Set-up DaskHub on Azure</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../posts/set-up-jh-gcp.html" class="pagination-link" aria-label="Set-up JHub on GCP">
        <span class="nav-page-text">Set-up JHub on GCP</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><img src="../images/nmfs-opensci-logo2-notext.png" alt="NMFS OpenSci logo" style="width:150px"><br>NMFS OpenSci (2023)</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>